---
letsencrypt_cert_domains:
   - ploong.openmrs.org

# Correct nginx-config role variables
nginx_config_http_template_enable: true
nginx_config_http_template:
  # HTTP redirect for ploong.openmrs.org
  - template_file: http/default.conf.j2
    deployment_location: /etc/nginx/conf.d/ploong.openmrs.org.80.conf
    config:
      servers:
        - core:
            listen:
              - address: "0.0.0.0"
                port: 80
                opts:
                  - default_server
            server_name: ploong.openmrs.org
          locations:
            - location: /
              core:
                return: "301 https://$host$request_uri"

  # HTTPS for ploong.openmrs.org (deployer)
  - template_file: http/default.conf.j2
    deployment_location: /etc/nginx/conf.d/ploong.openmrs.org.conf
    config:
      servers:
        - core:
            listen:
              - address: "0.0.0.0"
                port: 443
                opts:
                  - ssl
                  - http2
            server_name: ploong.openmrs.org
          log:
            access:
              - path: /var/log/nginx/deployer_access.log
            error:
              - file: /var/log/nginx/deployer_error.log
          ssl:
            certificate: /etc/letsencrypt/live/ploong.openmrs.org/fullchain.pem
            certificate_key: /etc/letsencrypt/live/ploong.openmrs.org/privkey.pem
          locations:
            - location: "^~ /.well-known/acme-challenge/"
              core:
                root: /usr/share/nginx/html

aws_access_key_id: '{{ vault_aws_access_key_id }}'
aws_secret_access_key: '{{ vault_aws_secret_access_key }}'
backup_tag: 'configured'

